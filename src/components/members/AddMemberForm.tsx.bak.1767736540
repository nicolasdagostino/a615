"use client";
import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import Label from "@/components/form/Label";
import Input from "@/components/form/input/InputField";
import Select from "@/components/form/Select";
import TextArea from "@/components/form/input/TextArea";
import Button from "@/components/ui/button/Button";
import Alert from "@/components/ui/alert/Alert";

export type MemberFormDefaults = {
  fullName?: string;
  email?: string;
  phone?: string;
  dob?: string; // YYYY-MM-DD
  notes?: string;

  plan?: string;
  monthlyFee?: string;
  expiresAt?: string; // YYYY-MM-DD

  credits?: string;

  status?: string;
  paymentMethod?: string;
  startDate?: string; // YYYY-MM-DD

  role?: "admin" | "coach" | "athlete";
};

type Props = {
  memberId?: string;
  defaultValues?: MemberFormDefaults;
  primaryButtonLabel?: string;
};

export default function AddMemberForm({
  memberId,
  defaultValues,
  primaryButtonLabel = "Save Member",
}: Props) {
  const router = useRouter();

  const plans = [
    { value: "unlimited", label: "Unlimited" },
    { value: "3x", label: "3x/week" },
    { value: "2x", label: "2x/week" },
    { value: "open-box", label: "Open Box" },
    { value: "drop-in", label: "Drop-in Pack" },
  ];

  const statusOptions = [
    { value: "active", label: "Activa" },
    { value: "expiring", label: "Por vencer" },
    { value: "expired", label: "Vencida" },
  ];

  const roleOptions = [
    { value: "athlete", label: "Athlete" },
    { value: "coach", label: "Coach" },
    { value: "admin", label: "Admin" },
  ];

  const paymentMethods = [
    { value: "cash", label: "Cash" },
    { value: "card", label: "Card" },
    { value: "transfer", label: "Transfer" },
  ];

  const [form, setForm] = useState<MemberFormDefaults>({
    fullName: "",
    email: "",
    phone: "",
    dob: "",
    notes: "",
    plan: "",
    monthlyFee: "",
    expiresAt: "",
    credits: "",
    status: "",
    paymentMethod: "",
    startDate: "",
    role: "athlete",
  });

  const [loading, setLoading] = useState(false);
  const [feedback, setFeedback] = useState<null | { variant: "success" | "error"; title: string; message: string }>(null);

  useEffect(() => {
    setForm({
      fullName: defaultValues?.fullName ?? "",
      email: defaultValues?.email ?? "",
      phone: defaultValues?.phone ?? "",
      dob: defaultValues?.dob ?? "",
      notes: defaultValues?.notes ?? "",
      plan: defaultValues?.plan ?? "",
      monthlyFee: defaultValues?.monthlyFee ?? "",
      expiresAt: defaultValues?.expiresAt ?? "",
      credits: defaultValues?.credits ?? "",
      status: defaultValues?.status ?? "",
      paymentMethod: defaultValues?.paymentMethod ?? "",
      startDate: defaultValues?.startDate ?? "",
      role: (defaultValues?.role as any) ?? "athlete",
    });
  }, [defaultValues]);

  const canSubmit = useMemo(() => {
    return (
      !!form.fullName?.trim() &&
      !!form.email?.trim() &&
      form.email!.includes("@") &&
      !loading
    );
  }, [form.fullName, form.email, loading]);

  const handleCancel = () => {
    setFeedback(null);
    router.push("/admin/members");
    router.refresh();
  };

  const handleSubmit = async () => {
    if (!canSubmit) return;

    setFeedback(null);
    setLoading(true);
    try {
      const role = (form.role || "athlete") as "admin" | "coach" | "athlete";

      const payload = {
        fullName: form.fullName?.trim(),
        email: form.email?.trim().toLowerCase(),
        phone: form.phone?.trim() || "",
        dob: form.dob || "",
        notes: form.notes || "",

        role, // ✅ AGREGAR

        plan: form.plan || "",
        monthlyFee: form.monthlyFee || "",
        expiresAt: form.expiresAt || "",
        credits: form.credits || "",
        status: form.status || "",
        paymentMethod: form.paymentMethod || "",
        startDate: form.startDate || "",
      };


      const method = memberId ? "PATCH" : "POST";
      const finalPayload: any = memberId ? { id: memberId, ...payload } : payload;

      let res: Response;

        const method = memberId ? "PATCH" : "POST";
        const finalPayload: any = memberId ? { id: memberId, ...payload } : payload;

        res = await fetch("/api/admin/members", {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(finalPayload),
        });

);
        } else {
          res = await fetch("/api/admin/members", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        }
      }
      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        setFeedback({
          variant: "error",
          title: "Could not save member",
          message: String(data?.error || "Could not save the member."),
        });
        setLoading(false);
        return;
      }

      setFeedback({
        variant: "success",
        title: memberId ? "Member updated" : "Invitation sent",
        message: memberId
          ? "Member updated successfully."
          : `Invitation sent to: ${data?.member?.email}. The athlete must open the email and create their password.`,
      });
      setLoading(false);

      router.push("/admin/members");
      router.refresh();
    } catch (err) {
      console.error(err);
      setFeedback({ variant: "error", title: "Unexpected error", message: "Unexpected error while saving the member." });
      setLoading(false);
    }
  };

  return (
    <div className="space-y-6">
      {feedback ? (
        <Alert
          variant={feedback.variant}
          title={feedback.title}
          message={feedback.message}
        />
      ) : null}
      {/* Member Details */}
      <div className="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
        <div className="border-b border-gray-200 px-6 py-4 dark:border-gray-800">
          <h2 className="text-lg font-medium text-gray-800 dark:text-white">
            Member Details
          </h2>
        </div>

        <div className="p-4 sm:p-6 dark:border-gray-800">
          <form>
            <div className="grid grid-cols-1 gap-5 md:grid-cols-2">
              <div>
                <Label>Full Name</Label>
                <Input
                  placeholder="Enter full name"
                  value={form.fullName}
                  onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                    setForm((p) => ({ ...p, fullName: e.target.value }))
                  }
                />
              </div>

              <div>
                <Label>Role</Label>
                <Select
                  options={roleOptions}
                  placeholder="Select role"
                  onChange={(value) => setForm((p) => ({ ...p, role: value as any }))}
                  defaultValue={form.role || "athlete"}
                />
              </div>


              <div>
                <Label>Email</Label>
                <Input
                  type="email"
                  placeholder="Enter email"
                  value={form.email}
                  onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                    setForm((p) => ({ ...p, email: e.target.value }))
                  }
                />
              </div>

              <div>
                <Label>Phone</Label>
                <Input
                  placeholder="Enter phone"
                  value={form.phone}
                  onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                    setForm((p) => ({ ...p, phone: e.target.value }))
                  }
                />
              </div>

              <div>
                <Label>Date of Birth</Label>
                <Input
                  type="date"
                  value={form.dob}
                  onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                    setForm((p) => ({ ...p, dob: e.target.value }))
                  }
                />
              </div>

              <div className="col-span-full">
                <Label>Notes</Label>
                <TextArea
                  rows={6}
                  placeholder="Notes (optional)"
                  value={form.notes}
                  onChange={(value) => setForm((p) => ({ ...p, notes: value }))}
                />
              </div>
            </div>
          </form>
        </div>
      </div>

      {/* Membership & Billing */}
      <div className="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
        <div className="border-b border-gray-200 px-6 py-4 dark:border-gray-800">
          <h2 className="text-lg font-medium text-gray-800 dark:text-white">
            Membership & Billing
          </h2>
        </div>

        <div className="space-y-5 p-4 sm:p-6">
          <div className="grid grid-cols-1 gap-5 sm:grid-cols-3">
            <div>
              <Label>Plan</Label>
              <Select
                options={plans}
                placeholder="Select plan"
                onChange={(value) => setForm((p) => ({ ...p, plan: value }))}
                defaultValue={form.plan}
              />
            </div>

            <div>
              <Label>Monthly Fee</Label>
              <Input
                placeholder="€79"
                value={form.monthlyFee}
                onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                  setForm((p) => ({ ...p, monthlyFee: e.target.value }))
                }
              />
            </div>

            <div>
              <Label>Expires At</Label>
              <Input
                type="date"
                value={form.expiresAt}
                onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                  setForm((p) => ({ ...p, expiresAt: e.target.value }))
                }
              />
            </div>
          </div>

          <div className="grid grid-cols-1 gap-5 sm:grid-cols-2">
            <div>
              <label className="mb-1 inline-block text-sm font-semibold text-gray-700 dark:text-gray-400">
                Credits / Sessions
              </label>
              <div className="flex h-11 divide-x divide-gray-300 overflow-hidden rounded-lg border border-gray-300 dark:divide-gray-800 dark:border-gray-700">
                <button
                  type="button"
                  className="inline-flex h-11 w-11 items-center justify-center bg-white text-gray-700 hover:bg-gray-100 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 25 24" fill="none">
                    <path d="M6.66699 12H18.6677" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                  </svg>
                </button>

                <div className="flex-1">
                  <input
                    type="text"
                    value={form.credits}
                    onChange={(e) =>
                      setForm((p) => ({ ...p, credits: e.target.value }))
                    }
                    className="h-full w-full border-0 bg-white text-center text-sm text-gray-700 outline-none focus:ring-0 dark:bg-gray-900 dark:text-gray-400"
                  />
                </div>

                <button
                  type="button"
                  className="inline-flex h-11 w-11 items-center justify-center bg-white text-gray-700 hover:bg-gray-100 dark:bg-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 25 24" fill="none">
                    <path d="M6.66699 12.0002H18.6677M12.6672 6V18.0007" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                  </svg>
                </button>
              </div>
            </div>

            <div>
              <Label>Status</Label>
              <Select
                options={statusOptions}
                placeholder="Select status"
                onChange={(value) => setForm((p) => ({ ...p, status: value }))}
                defaultValue={form.status}
              />
            </div>
          </div>

          <div className="grid grid-cols-1 gap-5 sm:grid-cols-2">
            <div>
              <Label>Payment Method</Label>
              <Select
                options={paymentMethods}
                placeholder="Select method"
                onChange={(value) =>
                  setForm((p) => ({ ...p, paymentMethod: value }))
                }
                defaultValue={form.paymentMethod}
              />
            </div>

            <div>
              <Label>Start Date</Label>
              <Input
                type="date"
                value={form.startDate}
                onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
                  setForm((p) => ({ ...p, startDate: e.target.value }))
                }
              />
            </div>
          </div>
        </div>
      </div>

      {/* Profile Photo */}
      <div className="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
        <div className="border-b border-gray-200 px-6 py-4 dark:border-gray-800">
          <h2 className="text-lg font-medium text-gray-800 dark:text-white">
            Profile Photo
          </h2>
        </div>

        <div className="p-4 sm:p-6">
          <label
            htmlFor="member-photo"
            className="shadow-theme-xs group hover:border-brand-500 block cursor-pointer rounded-lg border-2 border-dashed border-gray-300 transition dark:hover:border-brand-400 dark:border-gray-800"
          >
            <div className="flex justify-center p-10">
              <div className="flex max-w-[260px] flex-col items-center gap-4">
                <div className="inline-flex h-13 w-13 items-center justify-center rounded-full border border-gray-200 text-gray-700 transition dark:border-gray-800 dark:text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M20.0004 16V18.5C20.0004 19.3284 19.3288 20 18.5004 20H5.49951C4.67108 20 3.99951 19.3284 3.99951 18.5V16M12.0015 4L12.0015 16M7.37454 8.6246L11.9994 4.00269L16.6245 8.6246"
                      stroke="currentColor"
                      strokeWidth="1.5"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                  </svg>
                </div>
                <p className="text-center text-sm text-gray-500 dark:text-gray-400">
                  <span className="font-medium text-gray-800 dark:text-white/90">
                    Click to upload
                  </span>
                  or drag and drop SVG, PNG, JPG or GIF (MAX. 800x400px)
                </p>
              </div>
            </div>
            <input type="file" id="member-photo" className="hidden" />
          </label>
        </div>
      </div>

      <div className="flex flex-col gap-3 sm:flex-row sm:justify-end">
        <Button variant="outline" onClick={handleCancel}>
          Cancel
        </Button>
        <Button
          variant="primary"
          onClick={handleSubmit}
          disabled={!canSubmit}
        >
          {loading ? "Saving..." : primaryButtonLabel}
        </Button>
      </div>
    </div>
  );
}
